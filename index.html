<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>UCVM Research Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>

<body>
    <section class="section">
        <div class="container">
            <h1 class="title">UCVM Research Dashboard</h1>

            <div class="field is-grouped is-grouped-multiline">
                <div class="control">
                    <div class="select">
                        <select id="fieldFilter"></select>
                    </div>
                </div>
                <div class="control">
                    <div class="select">
                        <select id="subfieldFilter"></select>
                    </div>
                </div>
                <div class="control">
                    <div class="select">
                        <select id="topicFilter"></select>
                    </div>
                </div>
                <div class="control">
                    <div class="select">
                        <select id="authorFilter"></select>
                    </div>
                </div>
            </div>

            <div id="pubsChart" style="height:400px;"></div>
            <div id="fwciChart" style="height:400px;"></div>
            <div id="oaStatusChart" style="height:400px;"></div>
        </div>
    </section>

    <script>
        const CSV_PATH = 'data/openalex_all_authors_last5y_key_fields_dedup.csv';

        const parseCSV = (callback) => {
            Papa.parse(CSV_PATH, {
                download: true,
                header: true,
                complete: function(results) {
                    callback(results.data);
                }
            });
        };

        const populateFilter = (data, key, selectId) => {
            const select = document.getElementById(selectId);
            const values = Array.from(new Set(data.map(row => row[key]).filter(Boolean))).sort();
            select.innerHTML = '<option value="">All</option>' + values.map(v => `<option value="${v}">${v}</option>`).join('');
        };

        const filterData = (data) => {
            const field = document.getElementById('fieldFilter').value;
            const subfield = document.getElementById('subfieldFilter').value;
            const topic = document.getElementById('topicFilter').value;
            const author = document.getElementById('authorFilter').value;

            return data.filter(row =>
                (!field || row['primary_topic__field__display_name'] === field) &&
                (!subfield || row['primary_topic__subfield__display_name'] === subfield) &&
                (!topic || row['primary_topic__display_name'] === topic) &&
                (!author || row['author_name'] === author)
            );
        };

        const drawCharts = (data) => {
            const years = {};
            const fwci = {};
            const oaStatus = {};

            data.forEach(row => {
                const year = row['publication_year'];
                const status = row['open_access__oa_status'];
                const metric = parseFloat(row['fwci']) || 0;

                if (year) {
                    years[year] = (years[year] || 0) + 1;
                    fwci[year] = (fwci[year] || []).concat(metric);
                }

                if (status) {
                    oaStatus[status] = (oaStatus[status] || 0) + 1;
                }
            });

            const pubsTrace = {
                x: Object.keys(years),
                y: Object.values(years),
                type: 'bar'
            };

            const fwciTrace = {
                x: Object.keys(fwci),
                y: Object.values(fwci).map(v => v.reduce((a,b) => a+b, 0)/v.length),
                type: 'line'
            };

            const oaTrace = {
                labels: Object.keys(oaStatus),
                values: Object.values(oaStatus),
                type: 'pie'
            };

            Plotly.newPlot('pubsChart', [pubsTrace], { title: 'Publications per Year' });
            Plotly.newPlot('fwciChart', [fwciTrace], { title: 'Average FWCI per Year' });
            Plotly.newPlot('oaStatusChart', [oaTrace], { title: 'Open Access Status' });
        };

        parseCSV((data) => {
            populateFilter(data, 'primary_topic__field__display_name', 'fieldFilter');
            populateFilter(data, 'primary_topic__subfield__display_name', 'subfieldFilter');
            populateFilter(data, 'primary_topic__display_name', 'topicFilter');
            populateFilter(data, 'author_name', 'authorFilter');

            const render = () => drawCharts(filterData(data));

            document.getElementById('fieldFilter').onchange = render;
            document.getElementById('subfieldFilter').onchange = render;
            document.getElementById('topicFilter').onchange = render;
            document.getElementById('authorFilter').onchange = render;

            render();
        });
    </script>
</body>

</html>
